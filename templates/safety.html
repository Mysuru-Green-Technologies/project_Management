{% extends "base.html" %}

{% block title %}Safety Incidents{% endblock %}
{% block header %}Safety Compliance Tracking{% endblock %}

{% block actions %}
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addIncidentModal">
    <i class="bi bi-plus-circle"></i> Report Incident
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Incident</th>
                        <th>Date</th>
                        <th>Project</th>
                        <th>Severity</th>
                        <th>Reported By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incident in incidents %}
                    <tr>
                        <td>
                            <strong>{{ incident.incident_type }}</strong>
                            <small class="text-muted d-block">{{ incident.location }}</small>
                        </td>
                        <td>{{ incident.incident_date }}</td>
                        <td>
                            {% if incident.project_name %}
                            <a href="{{ url_for('project_details', project_id=incident.project_id) }}">
                                {{ incident.project_name }}
                            </a>
                            {% else %}N/A{% endif %}
                        </td>
                        <td>
                            <span class="badge 
                                {% if incident.severity == 'low' %}bg-info
                                {% elif incident.severity == 'medium' %}bg-warning
                                {% elif incident.severity == 'high' %}bg-danger
                                {% else %}bg-dark{% endif %}">
                                {{ incident.severity|title }}
                            </span>
                        </td>
                        <td>{{ incident.reported_by }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" 
                                    data-bs-target="#viewIncidentModal{{ incident.incident_id }}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning" data-bs-toggle="modal" 
                                    data-bs-target="#editIncidentModal{{ incident.incident_id }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="POST" action="{{ url_for('delete_safety_incident', incident_id=incident.incident_id) }}"
                                      onsubmit="return confirm('Are you sure you want to delete this safety incident?');">
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>

                    <!-- View Incident Modal -->
                    <div class="modal fade" id="viewIncidentModal{{ incident.incident_id }}" tabindex="-1" 
                         aria-labelledby="viewIncidentModalLabel{{ incident.incident_id }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="viewIncidentModalLabel{{ incident.incident_id }}">
                                        {{ incident.incident_type }} Incident
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <strong>Date:</strong> {{ incident.incident_date }}
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Location:</strong> {{ incident.location }}
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Severity:</strong>
                                            <span class="badge 
                                                {% if incident.severity == 'low' %}bg-info
                                                {% elif incident.severity == 'medium' %}bg-warning
                                                {% elif incident.severity == 'high' %}bg-danger
                                                {% else %}bg-dark{% endif %}">
                                                {{ incident.severity|title }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Project:</strong>
                                        {% if incident.project_name %}
                                        <a href="{{ url_for('project_details', project_id=incident.project_id) }}">
                                            {{ incident.project_name }}
                                        </a>
                                        {% else %}N/A{% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Description:</strong>
                                        <p>{{ incident.description }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Action Taken:</strong>
                                        <p>{{ incident.action_taken }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Reported By:</strong> {{ incident.reported_by }} on {{ incident.reported_at }}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Incident Modal -->
                    <div class="modal fade" id="editIncidentModal{{ incident.incident_id }}" tabindex="-1" 
                         aria-labelledby="editIncidentModalLabel{{ incident.incident_id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editIncidentModalLabel{{ incident.incident_id }}">
                                        Edit {{ incident.incident_type }} Incident
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="POST" action="{{ url_for('update_safety_incident', incident_id=incident.incident_id) }}">
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="incident_type{{ incident.incident_id }}" class="form-label">Incident Type</label>
                                            <input type="text" class="form-control" id="incident_type{{ incident.incident_id }}" 
                                                   name="incident_type" value="{{ incident.incident_type }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="incident_date{{ incident.incident_id }}" class="form-label">Incident Date</label>
                                            <input type="date" class="form-control" id="incident_date{{ incident.incident_id }}" 
                                                   name="incident_date" value="{{ incident.incident_date }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="project_id{{ incident.incident_id }}" class="form-label">Project</label>
                                            <select class="form-select" id="project_id{{ incident.incident_id }}" name="project_id">
                                                <option value="">Select Project</option>
                                                {% for project in projects %}
                                                <option value="{{ project.project_id }}" 
                                                    {% if incident.project_id == project.project_id %}selected{% endif %}>
                                                    {{ project.project_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="location{{ incident.incident_id }}" class="form-label">Location</label>
                                            <input type="text" class="form-control" id="location{{ incident.incident_id }}" 
                                                   name="location" value="{{ incident.location }}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="severity{{ incident.incident_id }}" class="form-label">Severity</label>
                                            <select class="form-select" id="severity{{ incident.incident_id }}" name="severity" required>
                                                <option value="low" {% if incident.severity == 'low' %}selected{% endif %}>Low</option>
                                                <option value="medium" {% if incident.severity == 'medium' %}selected{% endif %}>Medium</option>
                                                <option value="high" {% if incident.severity == 'high' %}selected{% endif %}>High</option>
                                                <option value="critical" {% if incident.severity == 'critical' %}selected{% endif %}>Critical</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="description{{ incident.incident_id }}" class="form-label">Description</label>
                                            <textarea class="form-control" id="description{{ incident.incident_id }}" 
                                                      name="description" rows="3" required>{{ incident.description }}</textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="action_taken{{ incident.incident_id }}" class="form-label">Action Taken</label>
                                            <textarea class="form-control" id="action_taken{{ incident.incident_id }}" 
                                                      name="action_taken" rows="3" required>{{ incident.action_taken }}</textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Incident Modal -->
<div class="modal fade" id="addIncidentModal" tabindex="-1" aria-labelledby="addIncidentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addIncidentModalLabel">Report Safety Incident</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_safety_incident') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="incident_type" class="form-label">Incident Type</label>
                        <input type="text" class="form-control" id="incident_type" name="incident_type" required>
                    </div>
                    <div class="mb-3">
                        <label for="incident_date" class="form-label">Incident Date</label>
                        <input type="date" class="form-control" id="incident_date" name="incident_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="project_id" class="form-label">Project</label>
                        <select class="form-select" id="project_id" name="project_id">
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.project_id }}">{{ project.project_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location" required>
                    </div>
                    <div class="mb-3">
                        <label for="severity" class="form-label">Severity</label>
                        <select class="form-select" id="severity" name="severity" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="action_taken" class="form-label">Action Taken</label>
                        <textarea class="form-control" id="action_taken" name="action_taken" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Report Incident</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set today's date as default for incident date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('incident_date').value = today;
    });
</script>
{% endblock %}