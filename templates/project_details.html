{% extends "base.html" %}

{% block title %}{{ project.project_name }}{% endblock %}
{% block header %}{{ project.project_name }}{% endblock %}

{% block actions %}
<div class="btn-group">
    <a href="{{ url_for('project_report', project_id=project.project_id) }}" class="btn btn-info">
        <i class="bi bi-graph-up"></i> Full Report
    </a>
    <a href="{{ url_for('export_project', project_id=project.project_id) }}" class="btn btn-success">
        <i class="bi bi-download"></i> Export
    </a>
    <a href="{{ url_for('edit_project', project_id=project.project_id) }}" class="btn btn-warning">
        <i class="bi bi-pencil"></i> Edit
    </a>
    <a href="{{ url_for('weather_forecast', project_id=project.project_id) }}" class="btn btn-info">
        <i class="bi bi-cloud-sun"></i> Weather
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Project Summary Card -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Project Summary</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Status:</span>
                    <span class="badge 
                        {% if project.status == 'completed' %}bg-success
                        {% elif project.status == 'in_progress' %}bg-primary
                        {% elif project.status == 'on_hold' %}bg-warning
                        {% elif project.status == 'cancelled' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ project.status|replace('_', ' ')|title }}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Start Date:</span>
                    <span class="fw-bold">{{ project.start_date }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>End Date:</span>
                    <span class="fw-bold">{{ project.end_date }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Budget:</span>
                    <span class="fw-bold">₹{{ "{:,.2f}".format(project.estimated_budget or 0) }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Actual Cost:</span>
                    <span class="fw-bold">₹{{ "{:,.2f}".format(progress.actual_cost or 0) }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Card -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Progress Overview</h5>
            </div>
            <div class="card-body text-center">
                {% set completion_percentage = (progress.completed_tasks / progress.total_tasks * 100) if progress.total_tasks > 0 else 0 %}
                <h2 class="display-4">{{ "%.1f"|format(completion_percentage) }}%</h2>
                <p class="text-muted">Tasks Completed</p>
                <div class="progress progress-thin mb-3">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ completion_percentage }}%" 
                         aria-valuenow="{{ completion_percentage }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100"></div>
                </div>
                <small class="text-muted">{{ progress.completed_tasks }} of {{ progress.total_tasks }} tasks</small>
            </div>
        </div>
    </div>

    <!-- Financial Card -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Financial Status</h5>
            </div>
            <div class="card-body text-center">
                <h4 class="mb-3">₹{{ "{:,.2f}".format(progress.actual_cost or 0) }}</h4>
                <p class="text-muted">Actual Cost</p>
                <h4 class="mb-3">₹{{ "{:,.2f}".format(progress.estimated_cost or 0) }}</h4>
                <p class="text-muted">Estimated Cost</p>
                {% set variance = (progress.estimated_cost or 0) - (progress.actual_cost or 0) %}
                <h4 class="{% if variance >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ₹{{ "{:,.2f}".format(variance) }}
                </h4>
                <p class="text-muted">Budget Variance</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>Task Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="taskStatusChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>Cost Breakdown</h5>
            </div>
            <div class="card-body">
                <canvas id="costBreakdownChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Project Timeline -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Project Timeline</h5>
    </div>
    <div class="card-body">
        <div id="ganttChart" style="height: 400px;"></div>
    </div>
</div>

<!-- Tabs for different sections -->
<ul class="nav nav-tabs mb-4" id="projectTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">Tasks</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="expenditures-tab" data-bs-toggle="tab" data-bs-target="#expenditures" type="button" role="tab">Expenditures</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">Documents</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="team-tab" data-bs-toggle="tab" data-bs-target="#team" type="button" role="tab">Team</button>
    </li>
</ul>

<div class="tab-content" id="projectTabsContent">
    <!-- Tasks Tab -->
    <div class="tab-pane fade show active" id="tasks" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Tasks</h5>
                <div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus"></i> Add Task
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Task Name</th>
                                <th>Type</th>
                                <th>Duration</th>
                                <th>Cost</th>
                                <th>Status</th>
                                <th>Subtasks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in main_tasks %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('task_details', task_id=task.task_id) }}">
                                        {{ task.task_name }}
                                    </a>
                                    {% if task.description %}
                                    <small class="text-muted d-block">{{ task.description|truncate(50) }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ task.task_type|title }}</td>
                                <td>
                                    {{ task.planned_start_date }} to {{ task.planned_end_date }}
                                    <br>
                                    <small class="text-muted">{{ task.estimated_days }} days</small>
                                </td>
                                <td>
                                    ₹{{ "{:,.2f}".format(task.estimated_cost or 0) }}
                                    {% if task.actual_cost and task.actual_cost > 0 %}
                                    <br>
                                    <small class="text-muted">Actual: ₹{{ "{:,.2f}".format(task.actual_cost) }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if task.status == 'completed' %}bg-success
                                        {% elif task.status == 'in_progress' %}bg-primary
                                        {% elif task.status == 'delayed' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ task.status|replace('_', ' ')|title }}
                                    </span>
                                </td>
                                <td>{{ task.subtask_count }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('task_details', task_id=task.task_id) }}" class="btn btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('edit_task', task_id=task.task_id) }}" class="btn btn-outline-warning">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addSubtaskModal" 
                                            data-task-id="{{ task.task_id }}" data-task-name="{{ task.task_name }}">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenditures Tab -->
    <div class="tab-pane fade" id="expenditures" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Project Expenditures</h5>
                <div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenditureModal">
                        <i class="bi bi-plus"></i> Add Expenditure
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Added By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expenditure in expenditures %}
                            <tr>
                                <td>{{ expenditure.expenditure_date }}</td>
                                <td>{{ expenditure.description }}</td>
                                <td>{{ expenditure.category }}</td>
                                <td>₹{{ "{:,.2f}".format(expenditure.amount) }}</td>
                                <td>{{ expenditure.created_by_name }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3">Total Expenditures</th>
                                <th>₹{{ "{:,.2f}".format(total_expenditures) }}</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Project Documents</h5>
                <div>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                        <i class="bi bi-upload"></i> Upload Document
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if documents %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Document Name</th>
                                <th>Description</th>
                                <th>Uploaded By</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documents %}
                            <tr>
                                <td>{{ doc.document_name }}</td>
                                <td>{{ doc.description|truncate(50) }}</td>
                                <td>{{ doc.uploaded_by }}</td>
                                <td>{{ doc.upload_date }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('download_document', document_id=doc.document_id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_document', document_id=doc.document_id) }}" 
                                              onsubmit="return confirm('Are you sure you want to delete this document?');">
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No documents uploaded for this project.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Team Tab -->
    <div class="tab-pane fade" id="team" role="tabpanel">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Project Team</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Assigned Workers</h6>
                        <div class="list-group">
                            {% for assignment in worker_assignments %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ assignment.worker_name }}</h6>
                                    <small class="text-muted">{{ assignment.specialization }}</small>
                                </div>
                                <span class="badge bg-primary rounded-pill">{{ assignment.hours_worked }} hours</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Subcontractors</h6>
                        {% if subcontractors %}
                        <div class="list-group">
                            {% for sub in subcontractors %}
                            <div class="list-group-item">
                                <h6 class="mb-1">{{ sub.company_name }}</h6>
                                <small class="text-muted">Contact: {{ sub.contact_person }}</small><br>
                                <small class="text-muted">Specialty: {{ sub.specialty }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No subcontractors assigned to this project.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include all modals (Add Task, Add Expenditure, Upload Document, etc.) -->
{% include 'modals/project_modals.html' %}

{% endblock %}

{% block extra_js %}
<!-- Load Google Charts Gantt Package -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Task Status Chart
    const taskStatusCtx = document.getElementById('taskStatusChart').getContext('2d');
    const taskStatusChart = new Chart(taskStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'In Progress', 'Not Started', 'Delayed'],
            datasets: [{
                data: [{{ progress.completed_tasks }}, 
                       {{ progress.in_progress_tasks }}, 
                       {{ progress.not_started_tasks }}, 
                       {{ progress.delayed_tasks }}],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(108, 117, 125, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(108, 117, 125, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // Cost Breakdown Chart
    const costBreakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
    const costBreakdownChart = new Chart(costBreakdownCtx, {
        type: 'bar',
        data: {
            labels: ['Labor', 'Materials', 'Expenditures'],
            datasets: [{
                label: 'Cost (₹)',
                data: [{{ labor_cost }}, {{ material_cost }}, {{ total_expenditures }}],
                backgroundColor: [
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(40, 167, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(23, 162, 184, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(40, 167, 69, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Gantt Chart
    google.charts.load('current', { 'packages': ['gantt'] });
    google.charts.setOnLoadCallback(drawChart);

    function toDate(dateStr) {
        const parts = dateStr.split('-');
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Task ID');
        data.addColumn('string', 'Task Name');
        data.addColumn('string', 'Resource');
        data.addColumn('date', 'Start Date');
        data.addColumn('date', 'End Date');
        data.addColumn('number', 'Duration');
        data.addColumn('number', 'Percent Complete');
        data.addColumn('string', 'Dependencies');

        data.addRows([
            {% for task in gantt_tasks %}
            [
                'T{{ task.task_id }}',
                '{{ task.task_name|escape }}',
                '{{ task.status|title }}',
                toDate('{{ task.start_date }}'),
                toDate('{{ task.end_date }}'),
                null,
                {% if task.status == 'completed' %} 100
                {% elif task.status == 'in_progress' %} 50
                {% elif task.status == 'delayed' %} 25
                {% else %} 0
                {% endif %},
                null
            ]{% if not loop.last %},{% endif %}
            {% endfor %}
        ]);

        var options = {
            height: 400,
            gantt: {
                trackHeight: 30
            }
        };

        var chart = new google.visualization.Gantt(document.getElementById('ganttChart'));
        chart.draw(data, options);
    }
</script>
{% endblock %}